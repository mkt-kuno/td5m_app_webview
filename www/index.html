<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TDS530 TCP Logger</title>
    <script src="tailwind.min.js"></script>
</head>
<body class="bg-gray-100 min-h-screen p-6">
    <div class="max-w-7xl mx-auto">
        <h1 class="text-3xl font-bold text-gray-800 mb-6">TDS530 Data Monitor</h1>
        
        <!-- Timestamp Display -->
        <div class="bg-white rounded-lg shadow-md p-4 mb-6">
            <div class="text-sm text-gray-600">Last Update:</div>
            <div id="timestamp" class="text-xl font-semibold text-gray-800">--</div>
        </div>

        <!-- Status + Controls -->
        <div class="mb-6 flex flex-col gap-3 md:flex-row md:items-center md:justify-between">
            <span id="status" class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-gray-200 text-gray-800">
                <span class="w-2 h-2 mr-2 rounded-full bg-gray-400"></span>
                Connecting...
            </span>
            <div class="flex items-center gap-3">
                <button id="startSaveBtn" class="px-4 py-2 rounded-md bg-blue-600 text-white hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed">保存開始</button>
                <button id="stopSaveBtn" class="px-4 py-2 rounded-md bg-gray-600 text-white hover:bg-gray-700 disabled:opacity-50 disabled:cursor-not-allowed" disabled>保存終了</button>
                <span id="saveStatus" class="text-sm text-gray-600">未保存</span>
            </div>
        </div>

        <!-- Data Cards Grid -->
        <div id="dataContainer" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-5 xl:grid-cols-10 gap-4">
            <!-- Cards will be inserted here dynamically -->
        </div>
    </div>

    <script>
        const dataContainer = document.getElementById('dataContainer');
        const timestampEl = document.getElementById('timestamp');
        const statusEl = document.getElementById('status');
        const startSaveBtn = document.getElementById('startSaveBtn');
        const stopSaveBtn = document.getElementById('stopSaveBtn');
        const saveStatusEl = document.getElementById('saveStatus');

        // Fetch/sync state
        let lastTime = null;
        let isFetching = false;
        let isSaving = false;

        function updateStatus(isConnected, message = '') {
            if (isConnected) {
                statusEl.innerHTML = `
                    <span class="w-2 h-2 mr-2 rounded-full bg-green-500 animate-pulse"></span>
                    Connected
                `;
                statusEl.className = 'inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-green-100 text-green-800';
            } else {
                statusEl.innerHTML = `
                    <span class="w-2 h-2 mr-2 rounded-full bg-red-500"></span>
                    ${message || 'Disconnected'}
                `;
                statusEl.className = 'inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-red-100 text-red-800';
            }
        }

        function formatChannelLabel(index) {
            return `CH${String(index).padStart(3, '0')}`;
        }

        function formatValue(value) {
            if (value === null || value === undefined) {
                return 'N/A';
            }
            return value.toFixed(2);
        }

        function renderData(data, time) {
            // Update timestamp
            timestampEl.textContent = time;

            // Clear existing cards
            dataContainer.innerHTML = '';

            // Create cards for each channel
            data.forEach((value, index) => {
                const card = document.createElement('div');
                card.className = 'bg-white rounded-lg shadow-md p-4 hover:shadow-lg transition-shadow duration-200';
                
                const isNull = value === null || value === undefined;
                const valueClass = isNull ? 'text-gray-400' : 'text-blue-600';
                
                card.innerHTML = `
                    <div class="text-xs font-semibold text-gray-600 mb-2">${formatChannelLabel(index)}</div>
                    <div class="text-2xl font-bold ${valueClass}">${formatValue(value)}</div>
                `;
                
                dataContainer.appendChild(card);
            });
        }

        async function fetchData() {
            if (isFetching) return;
            isFetching = true;
            try {
                // Use pywebview's JavaScript API to call Python method
                const jsonData = await pywebview.api.get_latest_data();
                
                if (jsonData.error) {
                    updateStatus(false, jsonData.error);
                    return;
                }
                
                if (jsonData.data && jsonData.time) {
                    // Only update UI when time changes
                    if (jsonData.time !== lastTime) {
                        lastTime = jsonData.time;
                        renderData(jsonData.data, jsonData.time);
                    }
                    updateStatus(true);
                    
                    // Update save status if saving
                    if (isSaving) {
                        saveStatusEl.textContent = `保存中: ${jsonData.data.length}ch / 最新 ${jsonData.time}`;
                    }
                } else {
                    updateStatus(false, 'Invalid data format');
                }
            } catch (error) {
                console.error('[fetchData] error:', error);
                updateStatus(false, 'Error: ' + error.message);
            } finally {
                isFetching = false;
            }
        }

        async function startSaving() {
            if (isSaving) return;
            
            startSaveBtn.disabled = true;
            saveStatusEl.textContent = '保存先を選択…';
            
            try {
                // Use pywebview's file dialog
                const result = await pywebview.api.select_save_file();
                
                if (result.cancelled) {
                    startSaveBtn.disabled = false;
                    saveStatusEl.textContent = '未保存';
                    return;
                }
                
                // Start saving on Python side
                const saveResult = await pywebview.api.start_saving(result.filepath);
                
                if (saveResult.error) {
                    startSaveBtn.disabled = false;
                    saveStatusEl.textContent = 'エラー: ' + saveResult.error;
                    return;
                }
                
                isSaving = true;
                startSaveBtn.disabled = true;
                stopSaveBtn.disabled = false;
                saveStatusEl.textContent = '保存中（TSV）';
                
            } catch (e) {
                console.error('[startSaving] error:', e);
                startSaveBtn.disabled = false;
                saveStatusEl.textContent = '未保存';
            }
        }

        async function stopSaving() {
            if (!isSaving) return;
            
            try {
                await pywebview.api.stop_saving();
                isSaving = false;
                startSaveBtn.disabled = false;
                stopSaveBtn.disabled = true;
                saveStatusEl.textContent = '保存完了（TSV）';
            } catch (e) {
                console.error('[stopSaving] error:', e);
                saveStatusEl.textContent = '保存エラー';
            }
        }

        // Wait for pywebview API to be ready
        window.addEventListener('pywebviewready', function() {
            // Verify API is available
            if (typeof pywebview === 'undefined' || typeof pywebview.api === 'undefined') {
                console.error('pywebview API is not available');
                updateStatus(false, 'API not available');
                return;
            }
            
            console.log('pywebview API is ready');
            
            startSaveBtn.addEventListener('click', () => { startSaving(); });
            stopSaveBtn.addEventListener('click', () => { stopSaving(); });

            // Initial fetch
            fetchData();
            // Poll every 500ms
            setInterval(fetchData, 500);
        });
    </script>
</body>
</html>
